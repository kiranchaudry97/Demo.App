@model Tuple<List<Demo.App.Models.OrderViewModel>, List<Demo.App.Models.Customer>, List<Demo.App.Models.Book>>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1 class="text-center my-4">Beheerpagina</h1>

<div class="container">
    <div class="row">
        <!-- Bestellingenlijst -->
        <div class="col-12 mb-4">
            <h2>Bestellingen</h2>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Bestelling ID</th>
                        <th>Klant</th>
                        <th>Boek(en)</th>
                        <th>Datum</th>
                        <th class="text-end">Totaal</th>
                        <th class="text-center">Acties</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    @foreach (var order in Model.Item1)
                    {
                        <tr>
                            <td>@order.Id</td>
                            <td>@order.CustomerName</td>
                            <td>
                                <ul class="mb-0">
                                    @for (int i = 0; i < (order.BookTitles?.Count ?? 0); i++)
                                    {
                                        var title = order.BookTitles[i];
                                        var price = (order.BookPrices != null && order.BookPrices.Count > i) ? order.BookPrices[i] : 0m;
                                        <li>@title - @ViewData["CurrencySymbol"] @price.ToString("N2")</li>
                                    }
                                </ul>
                            </td>
                            <td>@order.OrderDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td class="text-end fw-bold">@ViewData["CurrencySymbol"] @order.OrderTotal.ToString("N2")</td>
                            <td class="text-center">
                                <form method="post" action="/Order/Delete/@order.Id" onsubmit="return confirm('Weet je zeker dat je deze bestelling wilt verwijderen?');">
                                    <button type="submit" class="btn btn-sm btn-danger">Verwijderen</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Klantenlijst -->
        <div class="col-12 mb-4">
            <h2>Klantenbeheer</h2>
            <table class="table table-striped table-hover" id="customerTable">
                <thead class="table-dark">
                    <tr>
                        <th>Naam</th>
                        <th>Email</th>
                        <th class="text-center">Acties</th>
                    </tr>
                </thead>
                <tbody id="customerTableBody">
                    @foreach (var customer in Model.Item2)
                    {
                        <tr id="customer-@customer.Id" onclick="selectCustomer(@customer.Id, '@customer.Name', '@customer.Email')">
                            <td>@customer.Name</td>
                            <td>@customer.Email</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning" onclick="editCustomer(@customer.Id, '@customer.Name', '@customer.Email')">Bewerken</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCustomer(@customer.Id)">Verwijderen</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Klant details toevoegen/wijzigen -->
            <div class="mt-4">
                <h3>Klant Details</h3>
                <p class="text-muted">Gebruik dit formulier om een nieuwe klant toe te voegen, een bestaande klant aan te passen, of een overzicht van klanten te bekijken.</p>
                <form id="customerForm">
                    <input type="hidden" id="customerId" name="CustomerId" value="">
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Naam</label>
                        <input type="text" class="form-control" id="customerName" name="Name" placeholder="Voer klantnaam in" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="customerEmail" name="Email" placeholder="Voer klantemail in" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Opslaan</button>
                    <button type="button" class="btn btn-secondary" onclick="addCustomer()">Nieuwe klant</button>
                </form>
            </div>
        </div>

        <!-- Boekenlijst -->
        <div class="col-12">
            <h2>Boeken</h2>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Titel</th>
                        <th>Auteur</th>
                        <th>Prijs</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var book in Model.Item3)
                    {
                        <tr>
                            <td>@book.Title</td>
                            <td>@book.Author</td>
                            <td>@ViewData["CurrencySymbol"] @book.Price.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Bestel een boek voor een klant -->
            <div class="mt-4">
                <h3>Bestel een boek</h3>
                <form id="orderForm" method="post" action="/Order/Create">
                    <div class="mb-3">
                        <label for="selectCustomer" class="form-label">Klant</label>
                        <select class="form-select" id="selectCustomer" name="CustomerId" required>
                            <option value="">Selecteer een klant</option>
                            @foreach (var customer in Model.Item2)
                            {
                                <option value="@customer.Id">@customer.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="selectBook" class="form-label">Boek</label>
                        <select class="form-select" id="selectBook" name="BookId" required>
                            <option value="">Selecteer een boek</option>
                            @foreach (var book in Model.Item3)
                            {
                                <option value="@book.Id">@book.Title</option>
                            }
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Bestellen</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('customerForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const customerId = document.getElementById('customerId').value;
        const customerName = document.getElementById('customerName').value;
        const customerEmail = document.getElementById('customerEmail').value;

        if (!customerName || !customerEmail) {
            alert('Voer een geldige naam en e-mail in.');
            return;
        }

        // Ensure Id is a number (0 for new customer)
        const payload = { Id: customerId ? parseInt(customerId, 10) : 0, Name: customerName, Email: customerEmail };
        console.log('Sending payload to /Customer/Save:', payload);

        fetch('/Customer/Save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const table = document.getElementById('customerTable').querySelector('tbody');

                if (payload.Id && payload.Id > 0) {
                    // Update existing customer
                    const row = document.getElementById(`customer-${payload.Id}`);
                    if (row) {
                        row.innerHTML = `
                            <td>${data.name}</td>
                            <td>${data.email}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-warning" onclick="editCustomer(${data.id}, '${data.name}', '${data.email}')">Bewerken</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${data.id})">Verwijderen</button>
                            </td>
                        `;
                    }
                    // Update select dropdown text for edited customer
                    const select = document.getElementById('selectCustomer');
                    if (select) {
                        const opt = select.querySelector(`option[value="${data.id}"]`);
                        if (opt) opt.text = data.name;
                    }
                } else {
                    // Add new customer
                    const newRow = document.createElement('tr');
                    newRow.id = `customer-${data.id}`;
                    newRow.innerHTML = `
                        <td>${data.name}</td>
                        <td>${data.email}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning" onclick="editCustomer(${data.id}, '${data.name}', '${data.email}')">Bewerken</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${data.id})">Verwijderen</button>
                        </td>
                    `;
                    table.appendChild(newRow);

                    // Add new option to selectCustomer dropdown
                    const select = document.getElementById('selectCustomer');
                    if (select) {
                        const opt = document.createElement('option');
                        opt.value = data.id;
                        opt.text = data.name;
                        select.appendChild(opt);
                    }
                }

                // Clear the form
                addCustomer();
            })
            .catch(error => console.error('Error:', error));
    });
// Removed duplicate /Customer/Add handler. Using only /Customer/Save handler above.

<!-- Removed duplicate /Customer/Add submit handler to avoid conflicting requests. -->

function addCustomer() {
    // Clear the form for adding a new customer
    document.getElementById('customerId').value = '';
    document.getElementById('customerName').value = '';
    document.getElementById('customerEmail').value = '';
}

function editCustomer(id, name, email) {
    // Populate the form for editing an existing customer
    document.getElementById('customerId').value = id;
    document.getElementById('customerName').value = name;
    document.getElementById('customerEmail').value = email;
}

function deleteCustomer(customerId) {
    if (confirm('Weet je zeker dat je deze klant wilt verwijderen?')) {
        // Redirect to delete action
        window.location.href = `/Customer/Delete/${customerId}`;
    }
}

document.getElementById('orderForm').addEventListener('submit', function (event) {
    event.preventDefault();

    const customerId = document.getElementById('selectCustomer').value;
    const bookId = document.getElementById('selectBook').value;

    if (!customerId || !bookId) {
        alert('Selecteer een klant en een boek.');
        return;
    }

    fetch('/Order/Create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ CustomerId: customerId, BookId: bookId }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Update the "Bestellingenlijst" section dynamically
            const orderTableBody = document.getElementById('orderTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${data.id}</td>
                <td>${data.customerName}</td>
                <td>
                    <ul class="mb-0">
                        ${data.books.map((book, idx) => `<li>${book} - ${(ViewData["CurrencySymbol"] || '€')} ${data.prices && data.prices[idx] ? Number(data.prices[idx]).toFixed(2) : '0.00'}</li>`).join('')}
                    </ul>
                </td>
                <td>${data.orderDate}</td>
                <td class="text-end fw-bold">${(ViewData["CurrencySymbol"] || '€')} ${data.orderTotal?.toFixed(2)}</td>
            `;
            orderTableBody.appendChild(newRow);

            // Clear the form
            document.getElementById('orderForm').reset();
        })
        .catch(error => console.error('Error:', error));
});

function selectCustomer(id, name, email) {
    // Populate the form with customer data
    document.getElementById('customerId').value = id;
    document.getElementById('customerName').value = name;
    document.getElementById('customerEmail').value = email;

    // Scroll to the "Klant Details" section
    document.getElementById('customerForm').scrollIntoView({ behavior: 'smooth' });
}
</script>